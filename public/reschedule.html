<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation Page</title>
    <style>
         body, h1, h2, p {
    margin: 0;
    padding: 0;
}
        body {
    font-family: Arial, sans-serif;
    }

        header {
    background-color: #007BFF;
    color: #fff;
    text-align: center;
    padding: 5px ;
    }

        header a {
    display: inline-block;
    background-color: #fff;
    color: #007BFF;
    padding: 10px 20px;
    text-decoration: none;
    border-radius: 5px;
    margin-top: 20px;
    font-weight: bold;
    }

    footer {
         text-align: center;
         background-color: #333;
         color: #fff;
         padding: 0px ;
         margin-top: 200px;
        }
    .register-container {
            background-color: #fff;
            border-radius: 18px;
            padding: 45px;
            margin-top: 90px;
            margin-left: 475px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 300px;
        }

        .register-container h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-group button {
            width: 100%;
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .form-group button:hover {
            background-color: #0056b3;
        }

        body {
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        form {
            border: 1px solid #ccc;
            padding: 20px;
            margin-top: 20px;
        }
        label {
            display: block;
            margin-bottom: 10px;
        }
        input, 
        select{
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: #fff;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }

</style>
</head>
<body>
    <header>
        <h1> Tubigan Garden Resort</h1>
         
        <a id="lnk1" href= "Tubigan Garden Resort.html">Home</a>
        <a id="lnk2" href= "login.html">LogIn</a>
        <a href= "Amenity.html">Amenities</a>
        <a href= "contacts.html">Contact Us</a>
    </header>

    <div class="container">
    <form id="fomre">
        <input type="text" id="ID" name="reID" hidden>
        <label>Reservation ID:</label> 
        <input type="text" id="reservID" name="reresID" readonly>
        <label>Customer ID:</label>
        <input type="text" id="user" name="recID" readonly>
        <label>Chosen Amenity:</label>
        <input type="text" id="resAme" name="reresAmeName" readonly>
        <label>Original Date of Booking</label>
        <input type="date" id="bookin" name="reresBookeDate" readonly>
        <label>Original Date of Reservation</label>
        <input type="date" id="checkin" name="reresDate" readonly>
        <label>Original Day of Check Out</label>
        <input type="date" id="checkout" name="reresCheckoutDate" readonly>
        <label>Adjusted Date of Booking</label>
        <input type="date" id="bookin-nu" name="renBookeDate" readonly>
        <label>Adjusted Date of Reservation</label>
        <input type="date" id="checkin-nu" name="renewDate">
        <label id="lCOnu"></label>
        <input type="date" id="checkout-nu" name="renCheckout" readonly hidden>
            <input class="smol" type="number" id="daysaf" value=0 min=0 hidden> <span id="daysText" hidden>Days Checked In</span>
        <input type="text" id="ReNewStat" name="reschedStat" value="pending" hidden>
        <input type="date" id="dateposted"  name="reDatePost" hidden>
        <button type="button" id="addReSched" onclick="insertReSched()">Request Reschedule</button>
        <button type="button" onclick="window.location.replace('UserPage.html')">Cancel</button>
    </form>
    </div>
</body>

<script>
console.log(sessionStorage)

fetch(`/current_reservation`).then(response=>{
    if(response.ok){
        return response.json()
    }else {
      throw new Error('Error fetching data');
    }
  })
  .then(data =>{
    const r1=document.getElementById('reservID')
    r1.value=data.resID;
    const r2=document.getElementById('user')
    r2.value=data.rescID
    const r3=document.getElementById('resAme')
    r3.value=data.resAmeName
    const r4=document.getElementById('checkin')
    r4.value=data.resCheckinDate
    const r5=document.getElementById('checkout')
    r5.value=data.resCheckoutDate
    if(data.resTour=="Overnight"){
        document.getElementById('l-CO-nu').textContent="Adjusted Check-out Date"
        document.getElementById('checkout-nu').hidden=false
        document.getElementById('daysaf').hidden=false
        document.getElementById('daysText').hidden=false
    }
    const r6=document.getElementById('bookin')
    r6.value=data.resBookeDate
    document.getElementById('lnk1').href="UserPage.html"
    document.getElementById('lnk2').textContent="Log Out"

})

//#region days away from checkin to bookin
document.getElementById('checkin-nu').addEventListener('change',function(){
                var days=parseInt(document.getElementById('daysaf').value);
                const checkedA=new Date(document.getElementById('checkin-nu').value)
                checkedA.setDate(checkedA.getDate()+days)

                const checkedB=new Date(document.getElementById('checkin-nu').value)
                checkedB.setDate(checkedB.getDate()-3)

                document.getElementById('checkout-nu').valueAsDate=checkedA
                document.getElementById('bookin-nu').valueAsDate = checkedB
            })

document.getElementById('daysaf').addEventListener('change',function(){
                var days=parseInt(document.getElementById('daysaf').value);
                const checkedA=new Date(document.getElementById('checkin-nu').value)
                checkedA.setDate(checkedA.getDate()+days)

                const checkedB=new Date(document.getElementById('checkin-nu').value)
                checkedB.setDate(checkedB.getDate()-3)
                if(document.getElementById('checkin-nu').value==""){
                    
                }else{
                    document.getElementById('checkout-nu').valueAsDate=checkedA
                    document.getElementById('bookin-nu').valueAsDate = checkedB
                }
            })
//#endregion

let sameFlag,ameS,sameDateFlag,emptyFlag,diffResFlag
async function searchRA(){
    const ameI = document.getElementById('resAme').value;
    const ameResd=document.getElementById('user').value
    try {
        const response = await fetch('/amenities-data');
        const result = await response.json();
        if (response.ok) {
            for (const item of result) {
                const ame = item.ameName;
                const motoRes = await fetch(`/searchResAme?resAmeName=${ame}`);
                const zuttoRes = await motoRes.json();

                if (motoRes.ok && Array.isArray(zuttoRes.data)) {
                    for (const res of zuttoRes.data) {
                        const ameF = res.resAmeName;
                        const bookF = res.resBookeDate;
                        const ameResdF=res.rescID
                        console.log(ame + " " + ameI + " " + ameF);
                        console.log("reserved by "+ameResdF)
                        if (ameF == ame && ame == ameI && ameResd!=ameResdF) {
                            sameFlag = true;
                            ameS = ameF;
                            diffResFlag=true
                            const bookI = document.getElementById('checkin-nu').value;
                            if (bookF == bookI) {
                                sameDateFlag = true;
                            }
                        }
                    }
                }
                if(ameI==ame && item.ameLeft==0 || item.ameLeft==0 && diffResFlag==true){
                    emptyFlag=true
                    ameE=ameI
                }
                console.log("Same Amenity:"+sameFlag)
                console.log("Same Date:"+sameDateFlag)
                console.log("None Left:"+emptyFlag)
                console.log("Different Guy:"+diffResFlag)
            }
        }
    } catch (err) {
        console.error('Error:', err);
    }
    }


async function insertReSched(){
    await searchRA()
    if(sameDateFlag==true){
                conflict="there being a conflict with the Schedule"
            }else if(emptyFlag && sameFlag){
                conflict=`no more available instances of ${ameE}`
            }
            if(sameFlag==true && sameDateFlag==true || sameDateFlag==true && emptyFlag==true ||sameFlag==true && emptyFlag==true){
                alert(`Unable to proceed due to ${conflict}.`)
            }else{
                const reID=document.getElementById("ID");
        const reresID=document.getElementById("reservID")
        const recID=document.getElementById("user");
        const reresAmeName=document.getElementById("resAme");
        const reresBook=document.getElementById("bookin")
        const renewBook=document.getElementById("bookin-nu")
        const reresDate=document.getElementById("checkin");
        const renewDate=document.getElementById("checkin-nu")
        
        const reDatePost=document.getElementById("dateposted");
        if(reresID.value=="" || recID.value=="" || reresAmeName.value=="" || reresDate.value=="" ||renewDate.value=="" || reresBook.value=="" || renewBook.value==""){
            alert("Please fill up the entire field");
        }else{
                const dtPost = new Date()
                reDatePost.value=`${dtPost.getFullYear()}-${String(dtPost.getMonth() + 1).padStart(2, '0')}-${String(dtPost.getDate()).padStart(2, '0')}`
                const dtID=renewDate.valueAsDate.toLocaleDateString('en-US', { year: '2-digit', month: '2-digit', day: '2-digit' }).replace(/\//g, '');
                const rng=Math.floor(Math.random()*10);
                const rng2=Math.floor(Math.random()*10);
                const rng3=Math.floor(Math.random()*10);
                const rng4=Math.floor(Math.random()*10);
                reID.value=recID.value[0]+recID.value[1]+"-"+dtID+"-"+rng+rng2+rng3+rng4
                const fomdat=new FormData(document.getElementById('fomre'));
        const datum={
            reDatePost:reDatePost.value,
            reID:reID.value,
            reresID:reresID.value,
            recID:recID.value,
            reresAmeName:reresAmeName.value,
            reresCheckDate:reresDate.value,
            reresBookeDate:reresBook.value,
            renCheckDate:renewDate.value,
            renBookeDate:renewBook.value,
            reschedStat:"Pending"
        }
        try{
            const response = await fetch('/insertResched',{
            method:'POST',
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify(datum),
            });
            const result=await response.json();
            if (response.ok){
                alert(result.message);
                document.getElementById('fomre').reset();
            }else{
                alert(result.error);
            }
        }catch(err){
            console.error('E-E-ERROR! ',err);
            alert('An Error Occured While Inserting The Record.');
        }
        }
            }
    }

</script>

</html>