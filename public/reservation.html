<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation Page</title>
    <style>
         body, h1, h2, p {
    margin: 0;
    padding: 0;
}
        body {
    font-family: Arial, sans-serif;
    background-image: url('tubigan.jpg'); 
    background-repeat: no-repeat;
    background-size: cover;
    background-attachment: fixed;
    background-size: cover; 
    background-position: center;
    background-repeat: no-repeat; 
    margin: 0; 
    padding: 0;
    }

    header.style1 {
          display: flex;
          background-color: #007BFF;
          color: #fff;
          text-align: center;
          padding: 5px ;
          
        }
    div.styleRyle {
        padding: 75px 0px 0px 355px;
    }
        header.style1 a {
         display: inline-block;
         background-color: #fff;
         color: #007BFF;
         padding: 10px 150px;
         text-decoration: none;
         border-radius: 5px;
         margin-top: 20px;
         font-weight: bold;
        }
        header.style2 {
           background-color: #7cafc9;
           color: #fff;
          text-align: center;
          padding: 5px ;
        }
        header.style2 a {
         display: inline-block;
         background-color: #fff;
         color: #007BFF;
         padding: 10px 20px;
         text-decoration: none;
         border-radius: 5px;
         margin-top: 20px;
         font-weight: bold;
        }
        
	header.style2 nav{
          display: flex;
          justify-content: center;
          align-items: center;
        }
        header.style2 nav a{
            display: inline-block;
          padding: 10px 20px;
          text-decoration: none;
          color: #ff0202;
          background-color: rgb(226, 226, 83);
          border-radius: 35px;
          margin: 0 10px;
          transition: cubic-bezier(0.075, 0.82, 0.165, 1);
        }
        header.style2 nav a:hover{
          background-color: #007BFF;

        }
        header > img {
        height: 200px;
        width: 250px; 
        margin-right: 25px;}

    footer {
         text-align: center;
         background-color: #333;
         color: #fff;
         padding: 0px ;
         margin-top: 200px;
        }

        .btn {
            padding: 10px 30px;
            background-color: #007bff;
            color: #fff;
            text-decoration: none;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
    .register-container {
            background-color: #fff;
            border-radius: 18px;
            padding: 45px;
            margin-top: 90px;
            margin-left: 475px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 300px;
        }

        .register-container h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group option{
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .bn632-hover {
  width: 160px;
  font-size: 16px;
  font-weight: 600;
  color: #fff;
  cursor: pointer;
  margin: 20px;
  height: 55px;
  text-align:center;
  border: none;
  background-size: 300% 100%;
  border-radius: 50px;
  moz-transition: all .4s ease-in-out;
  -o-transition: all .4s ease-in-out;
  -webkit-transition: all .4s ease-in-out;
  transition: all .4s ease-in-out;
}

.bn632-hover:hover {
  background-position: 100% 0;
  moz-transition: all .4s ease-in-out;
  -o-transition: all .4s ease-in-out;
  -webkit-transition: all .4s ease-in-out;
  transition: all .4s ease-in-out;
}

.bn632-hover:focus {
  outline: none;
}

.bn632-hover.bn26 {
  background-image: linear-gradient(
    to right,
    #25aae1,
    #4481eb,
    #04befe,
    #3f86ed
  );
  box-shadow: 0 4px 15px 0 rgba(65, 132, 234, 0.75);
}

        body {
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0px;
            border-radius: 0px;
            backdrop-filter: blur(100%); 
            background-color: rgba(233, 230, 230, 0.8);
            box-shadow: 0 60px 80px rgba(0, 0, 0, 0.1);
            opacity: 100%;
        }
        h1 {
            text-align: center;
        }
        form {
            border: 1px solid #ccc;
            padding: 20px;
            margin-top: 20px;
        }
        label {
            display: block;
            margin-bottom: 10px;
        }
        input, 
        select{
            width: 95%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            
        }
        .smol{
            width: 6.05%;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }

</style>

    
</head>
<body>
    <header class="style1">
        <img src="5.png" alt="logo">
    <div class="styleRyle">
      
    </div>   
    </header>
    
    <header class="style2">
       <nav>  
    <header> 
        <a id="lnk1" href= "Tubigan Garden Resort.html">Home</a>
        <a id="lnk2" href= "LogIn.html">LogIn</a>
        <a href= "Amenity.html">Amenities</a>
        <a href= "contacts.html">Contact Us</a>
    </nav> </header>
    
    <div class="container">
        <form id="fomres">
            <input type="text" id="resID" name="resID" readonly hidden>
            <label id="l1">Username:</label>
            <input type="text" id="username" name="rescID" required>
            <label id="l2">Name:</label>
            <input type="text" id="fullname" name="rescName" required>
            <label id="l3">Email:</label>
            <input type="email" id="email" name="rescEmail" required>
            <label id="l4">Phone Number:</label>
            <input type="number" id="phono" name="rescphono" required oninput="javascript: if (this.value.length > 11) this.value = this.value.slice(0, 11);">
            <label id="l5">Password</label>
            <input type="password" id="pass" name="rescPass">
            <label id="l6">Confirm Password</label>
            <input type="password" id="passConf">
            <label id="l7">Number of People:</label>
            <input type="number" id="pax" name="resPax" value=1 required>
            <label id="l8">Number of Children:</label>
            <input type="number" id="cax" name="resCax" value=0 required>
            <label>Chosen Amenity:</label>
            <select id="selAme" name="resAmeName" required>
                <option id="default" value=0>Loading. . .</option>
            </select>
            <label id="l9">Booked Date:  </label>
            <input type="date" id="book-in" name="resBookeDate" readonly>
            <label id="l10">Check-In Date:</label>
            <input type="date" id="check-in" name="resCheckDate" required>
            <label id="l11"></label>
            <input type="date" id="check-out" name="resBookeDate" readonly hidden>
            <label id="l12">Tour Type:</label>
            <select id="selTour" name="resTour" required>
                <option></option>
                <option>Day Tour</option>
                <option>Night Tour</option>
                <option>Overnight</option>
            </select>
            <input class="smol" type="number" id="daysaf" value=0 min=0 hidden><span id="daysText" hidden>Days</span>
            <label id="l13">Price</label>
            <input id="price" name="resPrice" value="300.00" readonly><!--this is supposed to dynamically change as selAme is manipulated-->
            <label id="l14">Available Promos:</label>
            <select id="selPromo">
                <option id="default-Promo" value=""></option>
                <!--Oh boy, another one of these-->
            </select>
            <label id="l15">Payment Method:</label>
            <select id="selPayMeth" name="resPayMeth" required>
                <option value=""></option>
                <option value="GcashOL">Gcash - Online</option>
                <option value="GcashOS">Gcash - Onsite</option>
                <option value="Cash">Cash </option>
            </select>
            <button class="btn" type="button" id="addRes" onclick="validator()">Add Reservation</button>
        </form>
    </div>

    <script>
        const dt=new Date
//#region sessions activation
let modechange
let num
fetch('/updateGo').then(response=>{
    if(response.ok){
        return response.json()
    }else{
    }
}).then(data=>{
    let verdict=data.data
    modechange=verdict.toString()
    console.log(modechange)
    if(modechange!="no"){
        document.getElementById('selAme').addEventListener('change', function() {
        const selectedOption = parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           const price=document.getElementById('price');
           var x,y;
           if(document.getElementById('pax').value=="" && document.getElementById('cax').value==""){
            x=0;
            y=0;
           } else if(document.getElementById('pax').value!="" && document.getElementById('cax').value==""){
            x=300*parseFloat(document.getElementById('pax').value)
            y=0
           } else if(document.getElementById('pax').value=="" && document.getElementById('cax').value!=""){
            x=300
            y=300*parseFloat(document.getElementById('cax').value)
           }
           else {
            x=300*parseFloat(document.getElementById('pax').value)
            y=300*parseFloat(document.getElementById('cax').value)
           } 
           var nuPrice=(x+selectedOption)-y;
           price.value=nuPrice.toFixed(2);
           if (document.getElementById('selAme').value==""){
            price.value="300"
           }
        });

        document.getElementById('pax').addEventListener('change',function(){
            if(document.getElementById('pax').value <=0){
                document.getElementById('pax').value=0
            }
            const priceText=document.getElementById('price');
            var x,y,z;
           if(document.getElementById('pax').value=="" && document.getElementById('cax').value==""){
            x=0;
            y=0;
            z=parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           } else if(document.getElementById('pax').value!="" && document.getElementById('cax').value==""){
            x=300*parseFloat(document.getElementById('pax').value)
            y=0
            z=parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           } else if(document.getElementById('pax').value=="" && document.getElementById('cax').value!=""){
            x=300
            y=300*parseFloat(document.getElementById('cax').value)
            z=parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           }
           else {
            x=300*parseFloat(document.getElementById('pax').value)
            y=300*parseFloat(document.getElementById('cax').value)
            z=parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           } 
           if(x<y){
            document.getElementById('cax').value=document.getElementById('pax').value
           }else if(x==y){
            document.getElementById('cax').value=document.getElementById('cax').value-1
            if( document.getElementById('cax').value <=0){
                document.getElementById('cax').value=0
            }
           }else{
            var nuPrice=(x-y)+z;
           price.value=nuPrice.toFixed(2);
           }
        });

        document.getElementById('cax').addEventListener('change',function(){
            if( document.getElementById('cax').value <=0){
                document.getElementById('cax').value=0
            }
            const priceText=document.getElementById('price');
            var x,y,z;
           if(document.getElementById('pax').value=="" && document.getElementById('cax').value==""){
            x=0;
            y=0;
            z=parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           } else if(document.getElementById('pax').value!="" && document.getElementById('cax').value==""){
            x=300*parseFloat(document.getElementById('pax').value)
            y=0
            z=parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           } else if(document.getElementById('pax').value=="" && document.getElementById('cax').value!=""){
            x=300
            y=300*parseFloat(document.getElementById('cax').value)
           }
           else {
            x=300*parseFloat(document.getElementById('pax').value)
            y=300*parseFloat(document.getElementById('cax').value)
            z=parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           } 
           if(x<y){
            document.getElementById('cax').value=document.getElementById('pax').value
           }else if(x==y){
            document.getElementById('cax').value=document.getElementById('cax').value-1
            if( document.getElementById('cax').value <=0){
                document.getElementById('cax').value=0
            }
           }else{
            var nuPrice=(x-y)+z;
           price.value=nuPrice.toFixed(2);
           }
        });
        
}else{
    console.log("oop")
    document.getElementById('selAme').addEventListener('change', function() {
        const selectedOption = parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           const price=document.getElementById('price');
           var x,y;
           if(document.getElementById('pax').value=="" && document.getElementById('cax').value==""){
            x=300;
            y=0;
           } else if(document.getElementById('pax').value!="" && document.getElementById('cax').value==""){
            x=300*parseFloat(document.getElementById('pax').value)
            y=0
           } else if(document.getElementById('pax').value=="" && document.getElementById('cax').value!=""){
            x=300
            y=300*parseFloat(document.getElementById('cax').value)
           }
           else {
            x=300*parseFloat(document.getElementById('pax').value)
            y=300*parseFloat(document.getElementById('cax').value)
           } 
           var nuPrice=(x+selectedOption)-y;
           price.value=nuPrice.toFixed(2);
           if (document.getElementById('selAme').value==""){
            price.value="300"
           }
        });

        document.getElementById('pax').addEventListener('change',function(){
            if(document.getElementById('pax').value <=0){
                document.getElementById('pax').value=1
            }
            const priceText=document.getElementById('price');
            var x,y,z;
           if(document.getElementById('pax').value=="" && document.getElementById('cax').value==""){
            x=300;
            y=0;
            z=parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           } else if(document.getElementById('pax').value!="" && document.getElementById('cax').value==""){
            x=300*parseFloat(document.getElementById('pax').value)
            y=0
            z=parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           } else if(document.getElementById('pax').value=="" && document.getElementById('cax').value!=""){
            x=300
            y=300*parseFloat(document.getElementById('cax').value)
            z=parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           }
           else {
            x=300*parseFloat(document.getElementById('pax').value)
            y=300*parseFloat(document.getElementById('cax').value)
            z=parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           } 
           if(x<y){
            document.getElementById('cax').value=document.getElementById('pax').value
           }else if(x==y){
            document.getElementById('cax').value=document.getElementById('cax').value-1
            if( document.getElementById('cax').value <=0){
                document.getElementById('cax').value=0
            }
           }else{
            var nuPrice=(x-y)+z;
           price.value=nuPrice.toFixed(2);
           }
        });

        document.getElementById('cax').addEventListener('change',function(){
            if( document.getElementById('cax').value <=0){
                document.getElementById('cax').value=0
            }
            const priceText=document.getElementById('price');
            var x,y,z;
           if(document.getElementById('pax').value=="" && document.getElementById('cax').value==""){
            x=300;
            y=0;
            z=parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           } else if(document.getElementById('pax').value!="" && document.getElementById('cax').value==""){
            x=300*parseFloat(document.getElementById('pax').value)
            y=0
            z=parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           } else if(document.getElementById('pax').value=="" && document.getElementById('cax').value!=""){
            x=300
            y=300*parseFloat(document.getElementById('cax').value)
           }
           else {
            x=300*parseFloat(document.getElementById('pax').value)
            y=300*parseFloat(document.getElementById('cax').value)
            z=parseFloat(document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].value);
           } 
           if(x<y){
            document.getElementById('cax').value=document.getElementById('pax').value
           }else if(x==y){
            document.getElementById('cax').value=document.getElementById('cax').value-1
            if( document.getElementById('cax').value <=0){
                document.getElementById('cax').value=0
            }
           }else{
            var nuPrice=(x-y)+z;
           price.value=nuPrice.toFixed(2);
           }
        });      
}})


fetch(`/current_Mem`).then(response=>{
    if(response.ok){
        return response.json()
    }else {
    }
  })
  .then(data =>{
    const r1=document.getElementById('username')
    const rl1=document.getElementById('l1');
    rl1.textContent="Username: "+data.mID
    r1.readOnly=true;
    r1.value=data.mID;
    r1.hidden=true;
    const r2=document.getElementById('fullname')
    const rl2=document.getElementById('l2');
    rl2.textContent="Name: "+data.mName
    r2.readOnly=true;
    r2.value=data.mName
    r2.hidden=true;
    const r3=document.getElementById('email')
    const rl3=document.getElementById('l3');
    rl3.textContent="Email: "+data.mEmail
    r3.readOnly=true
    r3.value=data.mEmail
    r3.hidden=true;
    const r4=document.getElementById('phono')
    const rl4=document.getElementById('l4');
    rl4.textContent="Phone Number: "+data.mPhoNo
    r4.readOnly=true
    r4.value=data.mPhoNo
    r4.hidden=true;
    const r5=document.getElementById('pass')
    const rl5=document.getElementById('l5');
    rl5.textContent=""
    r5.readOnly=true
    r5.value=data.mPass
    r5.hidden=true;
    const r6=document.getElementById('passConf')
    const rl6=document.getElementById('l6');
    rl6.textContent=""
    r6.readOnly=true
    r6.value=data.mPass
    r6.hidden=true;
    document.getElementById('lnk1').href="UserPage.html"
    document.getElementById('lnk2').textContent="Log Out"
})

let primeResPrice,primeCax,primePax,idplus,payPicked,idFlag,ameWan;
fetch(`/current_Reservation`).then(response=>{
    if(response.ok){
        return response.json()
    }else{
          console.log('Record Not Found with that ID.');
          res.status(404).json({error:'An Error occured while looking for the record.'});
      }
  })
  .then(async data=>{
    ameWan=data.resAmeName
    idplus=data.resID;
    payPicked=data.resPayStat;
    payMeth=data.resPayMeth
    document.getElementById('pax').value=data.resPax
    document.getElementById('cax').value=data.resCax
    const r1=document.getElementById('username')
    const rl1=document.getElementById('l1');
    rl1.textContent="Username: "+data.rescID
    r1.readOnly=true;
    r1.value=data.rescID;
    r1.hidden=true;
    const r2=document.getElementById('fullname')
    const rl2=document.getElementById('l2');
    rl2.textContent="Name: "+data.rescName
    r2.readOnly=true;
    r2.value=data.rescName
    r2.hidden=true;
    const r3=document.getElementById('email')
    const rl3=document.getElementById('l3');
    rl3.textContent="Email: "+data.rescEmail
    r3.readOnly=true
    r3.value=data.rescEmail
    r3.hidden=true;
    const r4=document.getElementById('phono')
    const rl4=document.getElementById('l4');
    rl4.textContent="Phone Number: "+data.rescphono
    r4.readOnly=true
    r4.value=data.rescphono
    r4.hidden=true;
    const r5=document.getElementById('pass')
    const rl5=document.getElementById('l5');
    rl5.textContent=""
    r5.readOnly=true
    r5.value=data.rescPass
    r5.hidden=true;
    const r6=document.getElementById('passConf')
    const rl6=document.getElementById('l6');
    rl6.textContent=""
    r6.readOnly=true
    r6.value=data.rescPass
    r6.hidden=true;
    const r7=document.getElementById('pax');
    const rl7=document.getElementById('l7');
    rl7.textContent="Number of People: "+data.resPax
    r7.value=data.resPax
    primePax=data.resPax
    const r8=document.getElementById('cax');
    const rl8=document.getElementById('l8');
    rl8.textContent="Number of Children: "+data.resCax
    r8.value=data.resCax
    primeCax=data.resCax
    const r9=document.getElementById('book-in')
    const rl9=document.getElementById('l9')
    r9.value=data.resBookeDate
    const r10=document.getElementById('check-in')
    const rl10=document.getElementById('l10')
    r10.value=data.resCheckinDate
    r10.readOnly
    const r11=document.getElementById('check-out')
    const rl11=document.getElementById('l11')
    r11.value=data.resCheckoutDate
    r11.readOnly
    const r12=document.getElementById('selTour')
    const rl12=document.getElementById('l12')
    rl12.textContent="Selected Package: "+data.resTour
    r12.value=data.resTour
    r12.options[r12.selectedIndex].textContent=data.resTour
    const r13=document.getElementById('price')
    const rl13=document.getElementById('l13')
    rl13.textContent="Running Balance: "+data.resPrice
    r13.value=data.resPrice
    const r14=document.getElementById('selPromo')
    const rl14=document.getElementById('l14')
    rl14.textContent="Selected Promo:"
    r14.value=data.resPromo
    const r15=document.getElementById('selPayMeth')
    const rl15=document.getElementById('l15')
    r15.value=data.resPayMeth
    if(data.resPayStat=="Checked In"){
        const op=document.createElement(option)
        op.value="aCheckOut"
        op.textContent="Pay Later ~ (until Check Out)"
        r15.appendChild(op)
    }
    document.getElementById('lnk1').href="UserPage.html"
    document.getElementById('lnk2').textContent="Log Out"

    await fetch('/updateGo').then(response=>{
    if(response.ok){
        return response.json()
    }else{
    }
}).then(data=>{
    let verdict=data.data
    modechange=verdict.toString()
    if(modechange!="no"){
    console.log("updooting time")
fetch('/current_ResCount').then(response=>{
    if(response.ok){
        return response.json()
    }else {
      throw new Error('Error fetching data');
    }
}).then(async data=>{
    console.log(data)
    num=parseInt(data.count);
    if(num==1){
    document.getElementById('resID').value=idplus+"-"+num
    await insertRes()
    document.getElementById('price').value=0
    }else{
        document.getElementById('resID').value=idplus+"-"+num
        idFlag=true
        modechange="no"
        console.log("idFlag: " + idFlag)
        console.log("mode change: "+modechange)
        document.getElementById('price').value=0
    }
})
}
})
})

fetch('/promo-data').then(response=>{
        if (response.ok){
            return response.json()
        }else{
            throw new Error('Error fetching data');
        }
    }).then(data=>{
        const selectE=document.getElementById('selPromo')
        document.getElementById("default-Promo")
        data.forEach(item=>{
            const option=document.createElement('option')
            option.value=item.proName
            option.textContent=item.proName
            selectE.appendChild(option)
        })
    }).catch(error => {
    console.error('Error fetching data:', error);
  });         

//#endregion
//#region data fill-er-upper
        fetch('/amenities-data')
            .then(response => {
                if (response.ok) {
                    return response.json(); 
                } else {
                    throw new Error('Error fetching data');
                }
            })
            .then(data => {
                const selectElement = document.getElementById('selAme');
                document.getElementById('default').textContent = "";
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.ameCost; 
                    option.textContent = item.ameName; 
                    selectElement.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
//#endregion
//#region days away from checkin to bookin
document.getElementById('check-in').addEventListener('change',function(){
                var days=parseInt(document.getElementById('daysaf').value);
                const checkedA=new Date(document.getElementById('check-in').value)
                checkedA.setDate(checkedA.getDate()+days)

                const checkedB=new Date(document.getElementById('check-in').value)
                checkedB.setDate(checkedB.getDate()-3)

                document.getElementById('check-out').valueAsDate=checkedA
                document.getElementById('book-in').valueAsDate = checkedB
            })

document.getElementById('daysaf').addEventListener('change',function(){
                var days=parseInt(document.getElementById('daysaf').value);
                const checkedA=new Date(document.getElementById('check-in').value)
                checkedA.setDate(checkedA.getDate()+days)

                const checkedB=new Date(document.getElementById('check-in').value)
                checkedB.setDate(checkedB.getDate()-3)
                if(document.getElementById('check-in').value==""){
                    
                }else{
                    document.getElementById('check-out').valueAsDate=checkedA
                    document.getElementById('book-in').valueAsDate = checkedB
                }
            })
//#endregion

document.getElementById('selTour').addEventListener('change',function(){
    if(document.getElementById('selTour').value=="Overnight"){
        document.getElementById('daysaf').hidden=false
        document.getElementById('l11').textContent="Check-out Date:  "
        document.getElementById('daysText').hidden=false
        document.getElementById('check-out').hidden=false
    }else{
        document.getElementById('daysaf').hidden=true
        document.getElementById('l11').textContent=""
        document.getElementById('daysText').hidden=true
        document.getElementById('check-out').hidden=true
    }
})

function validator(){
            const ID=document.getElementById('resID');
            const rescID = document.getElementById('username');
            const rescName = document.getElementById('fullname');
            const resPax=document.getElementById('pax');
            const resCax=document.getElementById('cax');
            const resAmeName=document.getElementById('selAme');
            const resCheckinDate=document.getElementById('check-in');
            const resTour=document.getElementById('selTour');
            const resPayMeth=document.getElementById('selPayMeth');
            const rescEmail=document.getElementById('email');
            const rescphono=document.getElementById('phono');
            const rescPass=document.getElementById('pass');
            const rescPassC=document.getElementById('passConf');
            const rescBookeDate=document.getElementById('book-in');
            const resCheckoutDate=document.getElementById('check-out')
            if(rescID.value==""||rescName.value==""||resPax.value==""||resCax.value==""||resAmeName.value==""||resCheckinDate.value==""||resCheckoutDate.value==""||resTour.value==""||resPayMeth.value==""||rescphono.value==""||rescPass.value!=rescPassC.value||rescEmail.value==""||rescBookeDate.value==""){
                alert("Please fill all the transaction details fields.");
            }else{
                if(resCheckinDate.valueAsDate > dt.setDate(dt.getDate()+1)){
                    if(resPayMeth.value==="GcashOL"){
                    const confirmation=confirm("Would you like to pay now?");
                    if(confirmation){
                        alert("Please forward the payment to GCash number: 09X-XXXX-XXXX and send the proof of payment to their email address: tubiganresort2014@gmail.com")
                        const dt = resCheckinDate.valueAsDate.toLocaleDateString('en-US', { year: '2-digit', month: '2-digit', day: '2-digit' }).replace(/\//g, '');
                        ID.value=rescID.value[0]+rescName.value[0]+dt
                        payPicked="Unpaid"
                        notifier();
                        notifierCust();
                        return validatorPart2();
                    }else{
                        alert("Please do not forget to forward the payment to GCash Number: 09X-XXXX-XXXX. Otherwise, Payment Method will be changed to Onsite.")
                        const dt = resCheckinDate.valueAsDate.toLocaleDateString('en-US', { year: '2-digit', month: '2-digit', day: '2-digit' }).replace(/\//g, '');
                        ID.value=rescID.value[0]+rescName.value[0]+dt
                        payPicked="Unpaid"
                        return validatorPart2();
                    }
                }else{
                        alert(`Please do not forget to visit Tubigan Garden resort on or before ${rescBookeDate.valueAsDate} to settle your payments.`)
                        const dt = resCheckinDate.valueAsDate.toLocaleDateString('en-US', { year: '2-digit', month: '2-digit', day: '2-digit' }).replace(/\//g, '');
                        ID.value=rescID.value[0]+rescName.value[0]+dt
                        payPicked="Unpaid"
                        return validatorPart2();
                }
                }else{
                    alert("Please set a date that's further than that.")
                }
            }
        }


function validatorPart2(){
    if(modechange!="no" || idFlag==true){
        return updateRes()
    }else{
        return insertRes();
    }
}

let sameFlag,ameE,sameDateFlag,emptyFlag,diffResFlag
async function searchRA() {
    const ameI = document.getElementById('selAme').options[document.getElementById('selAme').selectedIndex].text;
    const ameResI=document.getElementById("username").value
    try {
        const response = await fetch('/amenities-data');
        const result = await response.json();

        if (response.ok) {

            for (const item of result) {
                const ame = item.ameName;

                const motoRes = await fetch(`/searchResAme?resAmeName=${ame}`);
                const zuttoRes = await motoRes.json();
                if (motoRes.ok && Array.isArray(zuttoRes.data)) {
                    for (const res of zuttoRes.data) {
                        const ameF = res.resAmeName;
                        const checkF = res.resCheckinDate;
                        const ameResdF=res.rescIDf
                        console.log(ameF + " " + ame + " "+ ameI)
                        if (ameF == ame && ame == ameI && ameResI!=ameResdF){
                            sameFlag = true;
                            ameS = ameF;
                            diffResFlag=true
                            const checkI = document.getElementById('check-in').value;
                            if (checkF==checkI) {
                                sameDateFlag = true;
                            }
                        }
                    }
                }else if(motoRes.ok && !Array.isArray(zuttoRes.data)){
                    const ameF = zuttoRes.resAmeName;
                        const checkF = zuttoRes.resCheckinDate;
                        console.log(ameF + " " + ame + " "+ ameI)
                        if (ameF == ame && ame == ameI) {
                            sameFlag = true;
                            ameS = ameF;
                            const checkI = document.getElementById('check-in').value;
                            if (checkF == checkI) {
                                sameDateFlag = true;
                            }
                        }
                }

                if (ameI == ame && item.ameLeft == 0) {
                    emptyFlag = true;
                    ameE = ameI;
                }
            }
            console.log("Empty Flag:"+emptyFlag)
            console.log("Same Flag:"+sameFlag)
            console.log("Same Date Flag:"+sameDateFlag)
            console.log("Different Guy:"+diffResFlag)
        } else {
            console.error('Response not okay:', response.statusText);
        }
    } catch (err) {
        console.error('Error:', err);
    }
}


async function updateAme(){
        const ameName=document.getElementById('selAme').options[selAme.selectedIndex].textContent;
        if(ameName !=""){
            let ameCostf,ameSizef,ameReservdf,ameLeftf
        try{
            const response=await fetch(`/searchAme?ameName=${ameName}`);
            const result=await response.json();
            if(response.ok){
                ameCostf=result.ameCost
                ameSizef=result.ameSize
                ameReservdf=result.ameReservd
                ameLeftf=result.ameLeft
            }else{
                alert("E-E-ERROR! ",result.error);
            }
        }catch(err){
            console.error("Error looking through the Database. ",err);
            alert('someone tripped over the wires!');
        }
        const ameLeftI=ameLeftf-1
        let ameResI=ameReservdf
        if(ameLeftI==0){
            ameResI="Unavailable"
        }
        if(ameLeftI>=0){
            const up={
            ameName:ameName,
            ameSize:ameSizef,
            ameCost:ameCostf,
            ameReservd:ameResI,
            ameLeft:ameLeftI
        }
        try{
            const response = await fetch('/updateAme',{
            method:'POST',
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify(up),
            });
            const result=await response.json();
            if (response.ok){
                console.log("success")
                location.reload()
            }else{
                alert(result.error);
            }
        }catch(err){
            console.error('E-E-ERROR! ',err);
            alert('An Error Occured While Inserting The Record.');
        }
        }
        }else{
            alert("Please input what to update.");
        }
    }

    let conflict
        async function insertRes(){
            if(idFlag){
                document.getElementById('resID').value=document.getElementById('resID').value+"-"+num
            }
            if(modechange=="no"){
                await searchRA()
            }
            if(emptyFlag==true && sameDateFlag==true){
                conflict=`there being a conflict with the Schedule in regards to Amenity ${ameE}`
            }
            else if(sameDateFlag==true){
                conflict="there being a conflict with the Schedule"
            }else if(emptyFlag==true && sameFlag==true){
                conflict=`no more available instances of ${ameE}`
            }
            if(sameFlag==true && sameDateFlag==true || sameDateFlag==true && emptyFlag==true ||sameFlag==true && emptyFlag==true){
                alert(`Unable to proceed due to ${conflict}.`)
            }else{
                const ID=document.getElementById('resID');
            const rescID = document.getElementById('username');
            const rescName = document.getElementById('fullname');
            const resPax=document.getElementById('pax');
            const resCax=document.getElementById('cax');
            const resAmeName=document.getElementById('selAme');
            const resAme = resAmeName && resAmeName.options[resAmeName.selectedIndex].textContent !== "Loading . . ." && resAmeName.options[resAmeName.selectedIndex].textContent !== "" 
    ? resAmeName.options[resAmeName.selectedIndex].textContent
    : ameWan;

            const resCheckinDate=document.getElementById('check-in');
            const resCheckoutDate=document.getElementById('check-out')
            const resTour=document.getElementById('selTour');
            const resPayMeth=document.getElementById('selPayMeth');
            const rescEmail=document.getElementById('email');
            const rescphono=document.getElementById('phono');
            const rescPass=document.getElementById('pass');
            const rescPassC=document.getElementById('passConf');
            const resBookeDate=document.getElementById('book-in');
            const resPrice=document.getElementById("price");
            const resPromo=document.getElementById('selPromo')
        const datum={
            resID:ID.value || IDee,
            rescID:rescID.value,
            rescName:rescName.value,
            rescEmail:rescEmail.value,
            rescphono:rescphono.value,
            rescPass:rescPass.value,
            resPax:resPax.value,
            resCax:resCax.value,
            resAmeName:resAme,
            resCheckinDate:resCheckinDate.value,
            resCheckoutDate:resCheckoutDate.value,
            resBookeDate:resBookeDate.value,
            resTour:resTour.value,
            resPrice:resPrice.value,
            resPromo:resPromo.value,
            resPayMeth:resPayMeth.value,
            resPayStat:payPicked,
            resAppStat:"Pending"
        }
        try{
            const response = await fetch('/insertRes',{
            method:'POST',
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify(datum),
            });
            const result=await response.json();
            if (response.ok){
                if(modechange==="no"){
                await updateAme()
                alert(result.message);
                console.log(modechange)
                location.reload()
                }else{
                console.log(modechange)
                location.reload()
                }
            }else{
                alert(result.error);
            }
            
        }catch(err){
            console.error('E-E-ERROR! ',err);
            alert('An Error Occured While Inserting The Record.');
        }
            }
    }

    let resAppStatf3
    async function updateRes(){
        const resID=document.getElementById('resID');
        if(resID.value==""){
            alert("Please input what you want to search")
        }else{
            const resIDf=document.getElementById('resID').value;
            let rescIDf, rescNamef,resPaxf,resCaxf,rescEmailf,rescphonof,rescpassf,resCheckinDatef,resCheckoutDatef,resBookDatef,resTourf,resPricef,resPayMethf,resPayStatf,resAppStatf,resPromof;
        try{
            const response=await fetch(`/searchRes?resID=${resIDf}`);
            const result=await response.json();
            if(response.ok){
                rescIDf=result.rescID
                rescNamef=result.rescName
                resPaxf=parseInt(result.resPax)+parseInt(document.getElementById('pax').value)
                resCaxf=parseInt(result.resCax)+parseInt(document.getElementById('cax').value)
                rescEmailf=result.rescEmail
                rescpassf=result.rescPass
                rescphonof=result.rescphono
                resAmeNamef=result.resAmeName+" , "+document.getElementById('selAme').options[selAme.selectedIndex].text
                resCheckinDatef=result.resCheckinDate
                resCheckoutDatef=result.resCheckoutDate
                resBookDatef=result.resBookeDate
                resTourf=result.resTour
                resPricef=parseInt(result.resPrice)+parseInt(document.getElementById('price').value);
                resPayMethf=result.resPayMeth
                resPayStatf=result.resPayStat
                resPromof=result.resPromo
                resAppStatf=result.resAppStat
                resAppStatf3=result.resAppStat
            }else{
                alert("E-E-ERROR! ",result.error);
            }
        }catch(err){
            console.error("Error looking through the Database. ",err);
            alert('someone tripped over the wires!');
        }
        const updoot={
            resID:resIDf,
            rescID:rescIDf,
            rescName:rescNamef,
            resPax:resPaxf,
            resCax:resCaxf,
            rescEmail:rescEmailf,
            rescPass:rescpassf,
            rescphono:rescphonof,
            resAmeName:resAmeNamef,
            resCheckinDate:resCheckinDatef,
            resCheckoutDate:resCheckoutDatef,
            resBookeDate:resBookDatef,
            resTour:resTourf,
            resPrice:resPricef,
            resPromo:resPromof,
            resPayMeth:resPayMethf,
            resPayStat:resPayStatf,
            resAppStat:resAppStatf
        }
        try{
            const response = await fetch('/updateRes',{
            method:'POST',
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify(updoot),
            });
            const result=await response.json();
            if (response.ok){
                alert(result.message);
                const motoRes=await fetch(`/current_ResCount`)
                const zutoRes=await motoRes.json()
                resID.value=resIDf.slice(0,8)
                let resBal=parseInt(document.getElementById('price').value)
                return insertRunBal(resAppStatf3,resID.value,resBal)
            }else{
                alert(result.error);
            }
        }catch(err){
            console.error('E-E-ERROR! ',err);
            alert('An Error Occured While Inserting The Record.');
        }
    }
    }

    async function insertRunBal(resAppStatf3,resID,resBal){
        if(resAppStatf3=="Checked In"){
            const motoRes=await fetch(`/searchRun?runresID=${resID}`)
            const zutoRes=await motoRes.json
            if(motoRes.ok){
                console.log('Dupe detected.')
                return updateRunBal(resAppStatf3,resID,resBal)
            }
                const datum={
                runresID:resID,
                runresPrice:resBal,
                runresBal:resBal,
                runresStat:"Unpaid"
            }
            try{
            const response = await fetch('/insertRun',{
            method:'POST',
            headers:{
                'Content-Type':'application/json'
            },
            body:JSON.stringify(datum),
            });
            const result=await response.json();
            if(response.ok){
                return insertRes()
            }
        }catch(err){
            console.error('E-E-ERROR! ',err);
        }
           
        }else{
            console.log("No.")
            return insertRes()
        }
    }

    async function updateRunBal(resAppStat,resID,resBal){
        const response=await fetch(`/searchRun?runresID=${resID}`);
        const result=await response.json();
        let runresPricef
        if(response.ok){
            runresPricef=result.runresPrice
        }
        const datum={
                runresID:resID,
                runresPrice:runresPricef,
                runresBal:runresPricef+resBal,
                runresStat:"Unpaid"
            }
            try {
        const response = await fetch('/updateRun', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(datum)
        });

        const result = await response.json();
        if(response.ok){
            return insertRes()
        }
    }catch(err){
        console.error('E-E-ERROR! ', err);
    }
    }

    async function notifier(){
            const sms=`Customer ${document.getElementById('fullname').value} with the Phone Number ${document.getElementById('phono').value} has made a reservation today. Please verify their payment.`
            try{
                const response=await fetch('/send-notification',{
                   method:'POST', 
                   headers: {
        'Content-Type': 'application/json',
      },
                   body:JSON.stringify({sms}),
                });
                const result = await response.json();
            console.log(result);
            }catch(error){
                console.log(error)
            }
        }

        async function notifierCust(){
            const sms=`Customer ${document.getElementById('fullname').value}, please email Tubigan Garden Resort a photograph of the GCash Receipt as proof of your transaction using the email, tubiganresort2014@gmail.com.`
            const sendo=document.getElementById('email').value
            const datum={paymentGate:sms,
                customer:sendo}
            try{
                const response=await fetch('/send-notification',{
                   method:'POST', 
                   headers: {
        'Content-Type': 'application/json',
      },
                   body:JSON.stringify({datum}),
                });
                const result = await response.json();
            console.log(result);
            }catch(error){
                console.log(error)
            }
        }

    </script>

    
    <footer>
        <p>&copy; (2014) Tubigan Garden Resort</p>
    </footer>
</body>
</html>
